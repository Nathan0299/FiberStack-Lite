version: '3.8'

services:
  # --- CONTROL PLANE ---
  fiber-db:
    container_name: fiber-db
    image: timescale/timescaledb:latest-pg14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=fiberstack
    volumes:
      - ../../fiber-db/schemas:/docker-entrypoint-initdb.d
    networks:
      - fiber-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  fiber-redis:
    image: redis:7-alpine
    networks:
      - fiber-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  fiber-api:
    container_name: fiber-api
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.api
    environment:
      - DB_HOST=fiber-db
      - REDIS_URL=redis://fiber-redis:6379/0
      - FEDERATION_SECRET=sandbox_secret
      - ENV=sandbox
    ports:
      - "8000:8000"
    depends_on:
      fiber-db:
        condition: service_healthy
      fiber-redis:
        condition: service_healthy
    networks:
      - fiber-network
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  fiber-etl:
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.etl
    environment:
      - DB_HOST=fiber-db
      - REDIS_URL=redis://fiber-redis:6379/0
      - ENV=sandbox
    depends_on:
      fiber-db:
        condition: service_healthy
      fiber-redis:
        condition: service_healthy
    networks:
      - fiber-network
    restart: on-failure
    # No direct healthcheck commonly exposed unless we add one to the container (e.g. touch file)
    # But for sandbox, we rely on API /status

  grafana:
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - DB_HOST=fiber-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASS=postgres
      - DB_NAME=fiberstack
      - ALERT_WEBHOOK_URL=http://localhost:8000/api/hook/dummy
      - ALERT_EMAIL_ADDR=dev@example.com
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/json/fiberstack-main.json
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    depends_on:
      - fiber-db
    networks:
      - fiber-network
    restart: on-failure
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # --- DATA PLANE (Probes) ---
  probe-accra:
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.probe
    environment:
      - API_URL=http://fiber-api:8000/api/ingest
      - FEDERATION_TOKEN_CLOUD=sandbox_secret
      - PROBE_API_KEY=sandbox_secret
      - NODE_ID=accra-1
      - LOG_LEVEL=INFO
    depends_on:
      fiber-api:
        condition: service_healthy
    networks:
      - fiber-network
    restart: on-failure

  probe-lagos:
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.probe
    environment:
      - API_URL=http://fiber-api:8000/api/ingest
      - FEDERATION_TOKEN_CLOUD=sandbox_secret
      - PROBE_API_KEY=sandbox_secret
      - NODE_ID=lagos-1
      - LOG_LEVEL=INFO
    depends_on:
      fiber-api:
        condition: service_healthy
    networks:
      - fiber-network
    restart: on-failure

  probe-nairobi:
    build:
      context: ../../
      dockerfile: fiber-deploy/docker/Dockerfile.probe
    environment:
      - API_URL=http://fiber-api:8000/api/ingest
      - FEDERATION_TOKEN_CLOUD=sandbox_secret
      - PROBE_API_KEY=sandbox_secret
      - NODE_ID=nairobi-1
      - LOG_LEVEL=INFO
    depends_on:
      fiber-api:
        condition: service_healthy
    networks:
      - fiber-network
    restart: on-failure

networks:
  fiber-network:
    driver: bridge
